import{I as l}from"./chunks/index.3ce4c7ef.js";import{_ as p,c as o,a,b as n,o as e}from"./app.264feb4a.js";const t="/docs/assets/1570772865704-16448011257641.3d3e0afc.png",c="/docs/assets/image-20210717161939695.69ecac52.png",r="/docs/assets/image-20220214092117990.63365aaa.png",D="/docs/assets/image-20210717162004285.8d8c512f.png",y="/docs/assets/image-20220214092442007.e360bc1b.png",i="/docs/assets/image-20210422095356088.b10aaed0.png",F="/docs/assets/1570773980987.a87e383d.png",A="/docs/assets/1570774154459.2539f169.png",C="/docs/assets/1570774384987.dfea9fd3.png",u="/docs/assets/1570774580138.2021bf58.png",d="/docs/assets/1570775118203.cc2566c7.png",h="/docs/assets/1570775498867.d76a0752.png",g="/docs/assets/1570775551238.ca5e9380.png",m="/docs/assets/1570776103472.995d7493.png",E="/docs/assets/image-20210717162628635.f866ae7e.png",b="/docs/assets/image-20210423191210349.46640728.png",q="/docs/assets/image-20220214104305480.9f22a505.png",f="/docs/assets/image-20220214093639892.663c6117.png",_="/docs/assets/image-20210717162752376.fc26e60c.png",v="/docs/assets/image-20220214183005771.c5bdeac0.png",k="/docs/assets/image-20210717163332646.8dd16c3a.png",x="/docs/assets/image-20210717163253264.d4e505d0.png",B="/docs/assets/image-20210717163604330.c39206ce.png",Q="/docs/assets/image-20210717163434647.67b67dae.png",S="/docs/assets/wpsED9A.tmp.e3d9a99e.jpg",M="/docs/assets/wpsED9B.tmp.bbbac296.jpg",j="/docs/assets/image-20210717164238910.26b8414c.png",T="/docs/assets/wps2FA3.tmp.1a696fcc.jpg",R="/docs/assets/wps2FA4.tmp.2a6d1aee.jpg",w="/docs/assets/image-20210717165309625.0b8762ba.png",P="/docs/assets/image-20210717165438225.353ac9cd.png",N="/docs/assets/image-20210717165509466.bb916ba5.png",O="/docs/assets/image-20210717165552676.e85d871d.png",I="/docs/assets/image-20220214100303630.32586aac.png",L="/docs/assets/image-20210717170041447.219be364.png",X="/docs/assets/image-20210717170223317.5d1927ff.png",V="/docs/assets/image-20210717170705380.5c7219d8.png",z="/docs/assets/image-20210717170829229.6b7e8a0a.png",K="/docs/assets/image-20200525170410401.cbe9cbbd.png",W="/docs/assets/image-20210422232835363.2ce0023b.png",U="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu4AAABZCAYAAABhTaEuAAAPd0lEQVR4nO3db2gcd37H8c8eBQecMrr6zMjgsPEfSDncvSKF1vKZQoQVLCilkXDjKITqCAeCPjsM+8C+tPjkBwumzwoL4UDGWJFrLPfZ+iyjQCxbDlhLsnVDA7J0Im68g+ucltRN/cBMH+y/2dHuzmj/zqzeL1hk7fz5/WZG6/3sb7/724ht27YatLS01OimAAAAALbhR93uAAAAAAAf7CbcuXOndANa5cGDB93uAlDh+++/t1++fGmvr6/btm3ba2tr/AzBz2+//db+4Ycf7O+++85++fKlDQBhVczbEdtuTanM8ePHW/JCAlhZWdHg4GC3uwEAABAIxcxNqQwAAAAQAgR3AAAAIAQI7gAAAEAIENwBAACAECC4AwAAACFAcAcAAABCgOAOAAAAhADBHQAAAAgBgjsAAAAQAgR3AAAAIAQI7gAAAEAIENwBAACAECC4AwAAACFAcAcAAABCgOAOAAAAhADBHQAAAAgBgjsAAAAQAgR3AAAAIAQI7jtCVrN/F1HkN8udae7+BUUiF9Sh1gAAAHYEgns3PZ7VeCSiiOt24X63OwYAAICg+aNudwDS9LKts0cLv9y/oMhQROnZJ7r+Xn9X+xUY30e63QMAQJj9sd3tHgAtwYh70Bw9q3vnpfkbi8p2uy8AAAAIDIJ7AB04PCZdW9e6pOwn41tKaSpq1e9fUCQyrtnHrp3cv+BZduPe9/gn2brLt7Ttaqt0GzrX8LEDAACgOkplAmh9dV46Na4Dhd/HnGUzj2c1/toxjR8u3Hd0WNM6p+t3sppwlNYsL5yTTl3Rh0e37l/Kh/J9E9KVb2xN7JekZV2I7FNk9Z7sXw+V1qvbdtX9qFDu07LTUYm3OwEAflBmiR7EiHvAZD8Z17GPpOlfTahfUv971ytr3fdP6Mx5aX51vXDHkD6cHdP8xG/Ls7g8ntVFxz62WtZvJ+Y1Nvsv5bCtIZ1dnpY+ulgavfduu9p+AAAA0A4E9wA4N1QuMymOXp91jJS7S1aOfVS5ff97ZzStc1oslMVk71zXfJ3Rdj1eV1rSwAFXrN9/QGOa17qj7KZu27X2AwAAgJYjuAfA9LIt2y7erjtGr/Pzr++bGNA9u7zOvfPuPQxp+Lx07p9nlVVWizfmNfbOcI3Rdr/8tg0AAIBOoMY9yB4v6vo1aXr5rLxKxod+cUVjr13X4ifrev/atO79a53Yvv+ABiSl17PSUcd6j9c1rzGN7/fZdmE/AAAAaD9G3IPMGbCL7l/YUiqTX3dY46fm9f7EOen8sEfQL9bF/4NjNpplXRg6J50/kx/x99V2YaR/yPktqYX9AAAAoKUI7oE2pLPfXJEm9pXrzBeGa5Sr9GviV9OSxnTlF95TuvS/d11PZqX3XyvWrx9TevaJY0YZf20P/drWvfPndKxUB7+o4eXpJo8bAAAAbhHbthueX29paan07+PHj7ekQ2jc8m8iOqbK6RzDaGVlRYODg+U7nFN6MR0kAMAPnjvQQ4qZmxp3Ly/+qds98Oe//j0/BeRnv5Ne/K7bvdmeXSE5xwAAAF1EqUyPWL40r/nxMX34F93uCQAAANqB4B521pqSF+9q46//UfaVP2tyCkigMaOjoy1bf3R0tHQDAABlBPdOyzxU4uJdJRef111evNVcD77UCoDF+4IaDpvtX73tncHY69YJ7jZTqVTpVm8b589G2mxm+3br9ePzEvbjD3r/a+2fF8xA8FHj3knWmpK3cjUXZ67dVWrD0OiZnyvWwW7lPdfCx18o3XdY8VNmx1tvJ3cALIbD4s+gabZ/XttXu68b56IYEJzt+gkN7T4/292XVP2c+lnejv616++7kWNptJ0gHn+n2m93/+vtv3g/gOBixL1jLM1dfiIN7FO02uLMw0JoP9KF0A50jt9R9TDw6n/Yj8+pl44l7LzCNeEb6F2MuHfEcy18vKqN6GHFh6W5dJXln+ek6OEmQruluYur2ij+Gi2PnFuLDzSTfmXLi4L8/dLAB2/K/OwLpXOScqtKXFyVJBkDf66p4d0qjcY73iyIvv1znY659/XCsfddGvjgTY0EbPC+26NxXsIwWrfdZe4R9WrvgNT6vdXvlnD9gy3sx9/u/jcb2Lt9fgA0j3ncvbRgOsjMtbtKbe7T5C8PyiwE7M1SKJaKoVtRQxsbzlIaH+HXWlPy8hPl5Bytd7VRWKevImy7S2NqlcpU6a9rf9VeGFiLD/TpT96sCPc1uaaDbOU87jxB+dPsedrO9u5w4QwSYQwWXn0N07F46aVjCbN2/s311DVmHnf0EOZx7xBr8UGhBOagauZv67k2JeW0V/EzR0p3Z67dVeryA8nHyHX0bedouqm3Br7RzCNL1vBBmeZBHYs+UerzNVmxQj8y60rndmngb+rv2Fr8RhvGPk2WXmRIKu7va0uKmbKevZCMP6k4PnP4TZ2u3+XAcdbweo36VltWbbTLz6hZoyNzjW7batsN20EP5vWuvXu51/b19uvVjp82tls772zb2Qf3v73aaebx0eyxN6uR61vvcR72xy+AcCG4t5O1phtpaeADf3Xr0TcqQ3Ts1GF9dXFVj/7juUbM3TW2qs78yStS+n9lSTIlxf5qn+5d/k4Z66BGTCnzdb40x+sFgfXshZR7opmLT6p0uNDPNwylbpXXcZfRdMt2w2ExULi3c/5eb5mfkeNapSLdDC+17utUn9wzXLh/dvLceF0vr1Kfesudf0Puv6lOqPXBQ/ffr9c2zT4+/JzTdtnu9Q3q47edgv7CGtjpCO5t90Lpy3e1paw9/YUS6WIpzG71tbsbpqlDxhOlP7M0ckr6akOKvu2zAD3qMdNM7IjiMZVKaDZu3VXiVvcDfKNPQPXW9xph75Rmn1S7FT7cIbfYl6CUynTq+jrbaeQ4uxmqmn18BKXvYX78thOhHQg2gns7mQc1deag685qNe6vao8hpQulJ62Q+TonGfsc5Su7NfKXhtK3nmph8f/y5S8+QrW5Z5eUfqqMTO93DUrHW6iXb+HxBEmtt/y3u30vqPWOQy21RmaDpNnru9MF/fzV65+fMp4gHhOAnYPgHgjFUL2quYxZGqXOXFvdWl/uR+ahUhtS9G1XXX1sr6K3VpVOS8aA6aq53y2zT9Lm81J5jSSZw68pml5V6uM1mb907C/zUMn/PqCp4d3KXLurr95wjq7/j57lJOPQq9vrdwi0InAGNbB2S71SmW6UEPXy9Wn3uxpBP3+t+FBnkI8PQO8juAdF7Iji5pqSl/NlJpIkozgTjZdd2vzcsZ1qlakUPrSafkXHqrwYKNbUF2vV89NBmjp95lUtfPyFq859lwY+yO8jX+Ne2b5R8Y5Cb2rVyFsjYScIH26r1u/tBsJW1zu38rz4ub6NflC1WZ26/s30vx3H3u7rW2sU3ms/YXz8AggnpoP00oLpIIMjX8Ly6FDAQnVApoOs9hZ5vfvqzcpRbdaOau24l/nV6if+7YaPZkcu681W0uwxtTL8e12/auvUWl5No/1s5vp7jbj76X8zjw+v7f32v1H1rq+fD5928/Fb71r4We63jZ55QcF0kOghxcxNcN9JvpxT4uamBv5+SiP93e5Mba0O7hIjW0WNjIJWCwZ+zme9df3OqtJMMEVvauf13QmzxtTTc/9fEtzRQwjuO46lheSM0j8eVfzdAMzVWEcrgzt2lp0UsnaiTlzfVoyoIyB47kAPIbj7YN1Oamb1kCanRnzUmaNVCO4AgKbx3IEe0vVvTrVuJzWzkqu+8PVgjgrn+6zAl5o05Ms5JW5uKHoyrtM/63ZnAAAA4NblWWWiGo2f9vWtokFgnphS/ES3e+FP5mpCqT8M+H+34GenFSewAwAABNaPut0BAAAAAN6CPY97dkHJS2n1nRyVbqa0Uby/WilNodSjzKgoaclcTSj1+/LSaiUhVct3DHcbjllZir+fPKRHN9MqbmkMTmrqROU4t3vfhmEoJ1f9fOF4cz5LhdzHVHwHw7ydLNyf1kwinV9U2GdpJH7omWYK58sYnNTUkUzhXBfOSxPn3jAM5XJ9oXo3BQAAIOi6HNw3lEoktOUz+65wuHHzK43G4zotScpoLpFS8rZZCsfl2vN4Kahbt5P61JLUXwy4jrKc7IKSlxJKPi0H7PI6U6Wwmf9wqtcx5JRelibj8XwAzy4oeWlGc3vLLwyq7TsfoLd5uhxKATxeDv6Zq0lZWSl2Ykqjz+qUyuTSmvnPUcXjp8v3Zau30+i5n1lp/NgAAACwVShq3KMnnevE9NPXU0o9sySZkjL6dCUnY3Cy4gOj5ompfNjMLuje71376B/RO4OPNLPyqTInTitWbR3fDA38rSMc98d0yEjr0dNC/2rs29xjSO7g3j+iqfiIjzYtWX+Q9GOzIpTH3p3y2eUBTfr88G9D535vn79+AAAAwLdgl8r4kbW0Kalvb42PYFrPlJOhQ67F+XC5KStbe52WaMu+TcUOG0qvpJRIpOQuC+oYr3MPAACAlgl/cN+hSjPcFOrL05cSSncrwAMAAKDtwh/c+031Sdoslqa4mXtkaEPPCvXuRdbTTUl9MvslaY8Mbbanf2Yb9y05pnHM158/emhppL9DI+CFc99Rzi/UAAAA2EF6YDrImN4aNJRbuaEFxwcsrdtJzX0pqX9Ex16XNm7OKVNcmF3QjZWcjMG38vXb/TEdMnJK/9uCLNc6TdvOvrMLSiYSSlzNbF1WwdJCMllxvO6yFXOPIeWeldtsi5h+6j63ymiuYnYfAAAAtEIoZpXxYp6Y0qSSmrmUULp0b1Sj8fy/Yu/GpauJirYqp4M0NTI1KSVnytMnGgMaHTSU8pxVxrN3bdi3qdhhuY638pjME+9oYHWmfMxt+jbarec2qtGTUW3cbHlTAAAAO1rEtm270Y2XlpZK/z5+/HhLOrRTZK4mlFJ7wnS35afRPOT/W1tdVlZWNDg42PJ+AQAAhFExc/dAqUzwlcp2iopTRP5pD4T2L+eUvO0syClMEXk41lBoBwAAQHXh/3BqSGzcTCjhKB+p9s2tYZVbmVHC8YVL1b45FgAAAM0huHdAaerGXlSa1QYAAADtRKkMAAAAEAIEdwAAACAECO4AAABACBDcAQAAgBAguAMAAAAhQHAHAAAAQoDgDgAAAIQAwR0AAAAIAYI7AAAAEAIEdwAAACAEIrZt241uvLS01Mq+AAAAAKiBEXcAAAAgBAjuAAAAQAg0VSoDAAAAoDMYcQcAAABCgOAOAAAAhADBHQAAAAgBgjsAAAAQAgR3AAAAIAQI7gAAAEAIENwBAACAEPh/ZEu8V9t5dpwAAAAASUVORK5CYII=",es=JSON.parse('{"title":"RabbitMQ 消息队列","description":"","frontmatter":{},"headers":[{"level":2,"title":"1.1 MQ简介","slug":"_1-1-mq简介","link":"#_1-1-mq简介","children":[]},{"level":2,"title":"1.2 MQ的作用：","slug":"_1-2-mq的作用","link":"#_1-2-mq的作用","children":[]},{"level":2,"title":"1.3.同步和异步通讯","slug":"_1-3-同步和异步通讯","link":"#_1-3-同步和异步通讯","children":[{"level":3,"title":"1.3.1.同步通讯","slug":"_1-3-1-同步通讯","link":"#_1-3-1-同步通讯","children":[]},{"level":3,"title":"1.3.2.异步通讯","slug":"_1-3-2-异步通讯","link":"#_1-3-2-异步通讯","children":[]}]},{"level":2,"title":"1.4 MQ的优势（理解-面试）","slug":"_1-4-mq的优势-理解-面试","link":"#_1-4-mq的优势-理解-面试","children":[{"level":3,"title":"1.4.1 任务异步处理","slug":"_1-4-1-任务异步处理","link":"#_1-4-1-任务异步处理","children":[]},{"level":3,"title":"1.4.2 应用程序解耦","slug":"_1-4-2-应用程序解耦","link":"#_1-4-2-应用程序解耦","children":[]},{"level":3,"title":"1.4.3 削峰填谷","slug":"_1-4-3-削峰填谷","link":"#_1-4-3-削峰填谷","children":[]},{"level":3,"title":"小结:","slug":"小结","link":"#小结","children":[]}]},{"level":2,"title":"1.5 MQ技术对比：","slug":"_1-5-mq技术对比","link":"#_1-5-mq技术对比","children":[]},{"level":2,"title":"2.1 RabbitMQ概述","slug":"_2-1-rabbitmq概述","link":"#_2-1-rabbitmq概述","children":[{"level":3,"title":"2.1.1 安装RabbitMQ","slug":"_2-1-1-安装rabbitmq","link":"#_2-1-1-安装rabbitmq","children":[]},{"level":3,"title":"2.1.2  RabbitMQ的图形管理界面","slug":"_2-1-2-rabbitmq的图形管理界面","link":"#_2-1-2-rabbitmq的图形管理界面","children":[]},{"level":3,"title":"2.1.3 RabbitMQ的基本结构：","slug":"_2-1-3-rabbitmq的基本结构","link":"#_2-1-3-rabbitmq的基本结构","children":[]}]},{"level":2,"title":"2.2.RabbitMQ消息模型","slug":"_2-2-rabbitmq消息模型","link":"#_2-2-rabbitmq消息模型","children":[]},{"level":2,"title":"2.3.导入Demo工程","slug":"_2-3-导入demo工程","link":"#_2-3-导入demo工程","children":[]},{"level":2,"title":"2.4.入门案例","slug":"_2-4-入门案例","link":"#_2-4-入门案例","children":[{"level":3,"title":"2.4.1.publisher实现","slug":"_2-4-1-publisher实现","link":"#_2-4-1-publisher实现","children":[]},{"level":3,"title":"2.4.2.consumer实现","slug":"_2-4-2-consumer实现","link":"#_2-4-2-consumer实现","children":[]}]},{"level":2,"title":"2.5.总结","slug":"_2-5-总结","link":"#_2-5-总结","children":[]},{"level":2,"title":"3.1.Basic Queue 简单队列模型","slug":"_3-1-basic-queue-简单队列模型","link":"#_3-1-basic-queue-简单队列模型","children":[{"level":3,"title":"3.1.1.消息发送","slug":"_3-1-1-消息发送","link":"#_3-1-1-消息发送","children":[]},{"level":3,"title":"3.1.2.消息接收","slug":"_3-1-2-消息接收","link":"#_3-1-2-消息接收","children":[]},{"level":3,"title":"3.1.3.测试","slug":"_3-1-3-测试","link":"#_3-1-3-测试","children":[]},{"level":3,"title":"小结：","slug":"小结-2","link":"#小结-2","children":[]}]},{"level":2,"title":"3.2.WorkQueue 工作队列模式","slug":"_3-2-workqueue-工作队列模式","link":"#_3-2-workqueue-工作队列模式","children":[{"level":3,"title":"3.2.1.消息发送","slug":"_3-2-1-消息发送","link":"#_3-2-1-消息发送","children":[]},{"level":3,"title":"3.2.2.消息接收","slug":"_3-2-2-消息接收","link":"#_3-2-2-消息接收","children":[]},{"level":3,"title":"3.2.3.测试","slug":"_3-2-3-测试","link":"#_3-2-3-测试","children":[]},{"level":3,"title":"3.2.4.能者多劳","slug":"_3-2-4-能者多劳","link":"#_3-2-4-能者多劳","children":[]},{"level":3,"title":"小结：","slug":"小结-3","link":"#小结-3","children":[]}]},{"level":2,"title":"3.3.发布/订阅","slug":"_3-3-发布-订阅","link":"#_3-3-发布-订阅","children":[]},{"level":2,"title":"3.4.Fanout 广播","slug":"_3-4-fanout-广播","link":"#_3-4-fanout-广播","children":[{"level":3,"title":"3.4.1.声明队列和交换机","slug":"_3-4-1-声明队列和交换机","link":"#_3-4-1-声明队列和交换机","children":[]},{"level":3,"title":"3.4.2.消息发送","slug":"_3-4-2-消息发送","link":"#_3-4-2-消息发送","children":[]},{"level":3,"title":"3.4.3.消息接收","slug":"_3-4-3-消息接收","link":"#_3-4-3-消息接收","children":[]},{"level":3,"title":"小结：","slug":"小结-5","link":"#小结-5","children":[]}]},{"level":2,"title":"3.5.Direct 定向","slug":"_3-5-direct-定向","link":"#_3-5-direct-定向","children":[{"level":3,"title":"3.5.1.基于注解声明队列和交换机","slug":"_3-5-1-基于注解声明队列和交换机","link":"#_3-5-1-基于注解声明队列和交换机","children":[]},{"level":3,"title":"3.5.2.消息发送","slug":"_3-5-2-消息发送","link":"#_3-5-2-消息发送","children":[]},{"level":3,"title":"小结：","slug":"小结-6","link":"#小结-6","children":[]}]},{"level":2,"title":"3.6  Topic  通配符","slug":"_3-6-topic-通配符","link":"#_3-6-topic-通配符","children":[{"level":3,"title":"3.6.1.说明","slug":"_3-6-1-说明","link":"#_3-6-1-说明","children":[]},{"level":3,"title":"3.6.2.消息发送","slug":"_3-6-2-消息发送","link":"#_3-6-2-消息发送","children":[]},{"level":3,"title":"3.6.3.消息接收","slug":"_3-6-3-消息接收","link":"#_3-6-3-消息接收","children":[]},{"level":3,"title":"小结：","slug":"小结-7","link":"#小结-7","children":[]}]},{"level":2,"title":"3.7.消息转换器","slug":"_3-7-消息转换器","link":"#_3-7-消息转换器","children":[{"level":3,"title":"3.7.1.测试默认转换器","slug":"_3-7-1-测试默认转换器","link":"#_3-7-1-测试默认转换器","children":[]},{"level":3,"title":"3.7.2.配置JSON转换器","slug":"_3-7-2-配置json转换器","link":"#_3-7-2-配置json转换器","children":[]},{"level":3,"title":"3.7.3.消息发送","slug":"_3-7-3-消息发送","link":"#_3-7-3-消息发送","children":[]},{"level":3,"title":"3.7.4.消息接收","slug":"_3-7-4-消息接收","link":"#_3-7-4-消息接收","children":[]}]}],"relativePath":"zh/java/面试重点技术/04-RabbitMQ课程讲义/RabbitMQ-qiang.md","lastUpdated":1675892686000}'),H={name:"zh/java/面试重点技术/04-RabbitMQ课程讲义/RabbitMQ-qiang.md"},Y=n('<h1 id="rabbitmq-消息队列" tabindex="-1">RabbitMQ 消息队列 <a class="header-anchor" href="#rabbitmq-消息队列" aria-hidden="true">#</a></h1><blockquote><p>两天学习：</p><ul><li>今天day01: 实用为主</li><li>项目2后： 高级面试点为主</li></ul></blockquote><h1 id="_0-学习目标" tabindex="-1">0.学习目标 <a class="header-anchor" href="#_0-学习目标" aria-hidden="true">#</a></h1><ul><li>了解同步和异步通讯的优缺点</li><li>了解各种MQ技术的优缺点</li><li>能利用SpringAMQP收发消息 <ul><li>能基于@Bean声明队列、交换机、绑定关系</li><li>能基于@RabbitListener声明队列、交换机、绑定关系</li><li>能配置SpringAMQP的消息转换器</li></ul></li></ul><blockquote><p>带着问题学习：</p><ul><li>什么是MQ？</li><li>MQ有什么作用？</li></ul></blockquote><h1 id="_1-初识mq" tabindex="-1">1.初识MQ <a class="header-anchor" href="#_1-初识mq" aria-hidden="true">#</a></h1><h2 id="_1-1-mq简介" tabindex="-1">1.1 MQ简介 <a class="header-anchor" href="#_1-1-mq简介" aria-hidden="true">#</a></h2><blockquote><p>MQ（Message Queue）消息队列，是一种用来保存消息数据的队列</p></blockquote><p><img src="'+t+'" alt="1570772865704"></p><h2 id="_1-2-mq的作用" tabindex="-1">1.2 MQ的作用： <a class="header-anchor" href="#_1-2-mq的作用" aria-hidden="true">#</a></h2><p>==在项目中，可将一些无需即时返回且耗时的操作提取出来，进行<strong>异步处理</strong>，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而<strong>提高</strong>了<strong>系统</strong>的<strong>吞吐量</strong>。==</p><h4 id="mq应用场景" tabindex="-1">MQ应用场景 <a class="header-anchor" href="#mq应用场景" aria-hidden="true">#</a></h4><ol><li>任务<strong>异步</strong>处理</li><li>应用程序<strong>解耦</strong></li><li>削峰填谷</li></ol><h2 id="_1-3-同步和异步通讯" tabindex="-1">1.3.同步和异步通讯 <a class="header-anchor" href="#_1-3-同步和异步通讯" aria-hidden="true">#</a></h2><p>微服务间通讯有同步和异步两种方式：</p><p>同步通讯：就像打电话，需要实时响应。</p><p>异步通讯：就像发邮件，不需要马上回复。</p><p><img src="'+c+'" alt="image-20210717161939695"></p><p>两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发送邮件可以同时与多个人收发邮件，但是往往响应会有延迟。</p><h3 id="_1-3-1-同步通讯" tabindex="-1">1.3.1.同步通讯 <a class="header-anchor" href="#_1-3-1-同步通讯" aria-hidden="true">#</a></h3><p><img src="'+r+'" alt="image-20220214092117990"></p><p>我们之前学习的Feign调用就属于同步方式，虽然调用可以实时得到结果，但存在下面的问题：</p><p><img src="'+D+'" alt="image-20210717162004285"></p><blockquote><p><strong>同步调用的优点：</strong></p><ul><li>时效性较强，可以立即得到结果</li></ul><p><strong>同步调用的问题：</strong></p><ul><li>耦合度高</li><li>性能和吞吐能力下降</li><li>有额外的资源消耗</li><li>有级联失败问题</li></ul></blockquote><h3 id="_1-3-2-异步通讯" tabindex="-1">1.3.2.异步通讯 <a class="header-anchor" href="#_1-3-2-异步通讯" aria-hidden="true">#</a></h3><p>异步调用则可以避免上述问题：</p><p><img src="'+y+'" alt="image-20220214092442007"></p><p>我们以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，调用物流服务，从仓库分配响应的库存并准备发货。</p><p>在事件模式中，支付服务是事件发布者（publisher），在支付完成后只需要发布一个支付成功的事件（event），事件中带上订单id。</p><p>订单服务和物流服务是事件订阅者（Consumer），订阅支付成功的事件，监听到事件后完成自己业务即可。</p><p>为了解除事件发布者与订阅者之间的耦合，两者并不是直接通信，而是有一个中间人（Broker）。发布者发布事件到Broker，不关心谁来订阅事件。订阅者从Broker订阅事件，不关心谁发来的消息。</p><p><img src="'+i+'" alt="image-20210422095356088"></p><p>Broker 是一个像数据总线一样的东西，所有的服务要接收数据和发送数据都发到这个总线上，这个总线就像协议一样，让服务间的通讯变得标准和可控。</p><blockquote><p><strong>好处：</strong></p><ul><li><p>吞吐量提升：无需等待订阅者处理完成，响应更快速</p></li><li><p>故障隔离：服务没有直接调用，不存在级联失败问题</p></li><li><p>调用间没有阻塞，不会造成无效的资源占用</p></li><li><p>耦合度极低，每个服务都可以灵活插拔，可替换</p></li><li><p>流量削峰：不管发布事件的流量波动多大，都由Broker接收，订阅者可以按照自己的速度去处理事件</p></li></ul><p><strong>缺点：</strong></p><ul><li>架构复杂了，业务没有明显的流程线，不好管理</li><li>需要依赖于Broker的可靠、安全、性能</li></ul></blockquote><h2 id="_1-4-mq的优势-理解-面试" tabindex="-1">1.4 MQ的优势（理解-面试） <a class="header-anchor" href="#_1-4-mq的优势-理解-面试" aria-hidden="true">#</a></h2><h3 id="_1-4-1-任务异步处理" tabindex="-1">1.4.1 任务<strong>异步</strong>处理 <a class="header-anchor" href="#_1-4-1-任务异步处理" aria-hidden="true">#</a></h3><p><img src="'+F+'" alt="1570773980987"></p><p>一个下单操作耗时：20 + 300 + 300 + 300 = 920ms</p><p>用户点击完下单按钮后，需要等待920ms才能得到下单响应，太慢！处理速度慢, 积压在系统的请求就更多 , 占用的系统资源就越多 , 系统的吞吐量就越低</p><p>可以使用MQ提升系统的处理速度 , 提供用户体验, 提升系统的吞吐量</p><p><img src="'+A+'" alt="1570774154459"></p><p>用户点击完下单按钮后，只需等待25ms就能得到下单响应 (20 + 5 = 25ms)。</p><p><strong>提升用户体验和系统吞吐量（单位时间内处理请求的数目）</strong></p><h3 id="_1-4-2-应用程序解耦" tabindex="-1">1.4.2 应用程序解耦 <a class="header-anchor" href="#_1-4-2-应用程序解耦" aria-hidden="true">#</a></h3><p>假如我们完成下单的过程中 , 库存系统服务发生了问题, 调用失败, 那么用户下单操作也就失败了</p><p><img src="'+C+'" alt="1570774384987"></p><p><strong>系统的耦合性越高，容错性就越低，可维护性就越低。</strong></p><p>可以使用MQ降低系统模块之间的耦合</p><p><img src="'+u+'" alt="1570774580138"></p><p>使用 MQ 使得应用间解耦 , 当其他子系统发生问题之后, 并不会影响核心功能的执行 , 提升容错性和可维护性。</p><h3 id="_1-4-3-削峰填谷" tabindex="-1">1.4.3 削峰填谷 <a class="header-anchor" href="#_1-4-3-削峰填谷" aria-hidden="true">#</a></h3><p>假设平常时段我们的系统每秒最多可以处理1000个用户请求 , 但是某一时刻请求瞬间增多, 每秒有5000甚至10000个请求访问系统, 这个时候服务器承载不了就会导致服务器崩溃</p><p><img src="'+d+'" alt="1570775118203"></p><p>使用MQ可以帮助我们规避这种风险</p><p><img src="'+h+'" alt="1570775498867"></p><p>使用了 MQ 之后，限制消费消息的速度为1000，这样一来，高峰期产生的数据势必会被积压在 MQ 中，高峰就被“削”掉了，但是因为消息积压，在高峰期过后的一段时间内，消费消息的速度还是会维持在1000，直到消费完积压的消息，这就叫做“填谷”。</p><p><img src="'+g+'" alt="1570775551238"></p><p><strong>使用MQ后，可以提高系统稳定性</strong></p><h3 id="小结" tabindex="-1">小结: <a class="header-anchor" href="#小结" aria-hidden="true">#</a></h3><blockquote><ul><li>应用解耦：提高系统容错性和可维护性</li><li>异步提速：提升用户体验和系统吞吐量</li><li>削峰填谷：提高系统稳定性</li></ul></blockquote><h2 id="_1-5-mq技术对比" tabindex="-1">1.5 MQ技术对比： <a class="header-anchor" href="#_1-5-mq技术对比" aria-hidden="true">#</a></h2><p>MQ，中文是消息队列（MessageQueue），字面来看就是存放消息的队列。也就是事件驱动架构中的Broker。</p><p>比较常见的MQ实现：</p><ul><li>ActiveMQ</li><li>RabbitMQ</li><li>RocketMQ</li><li>Kafka</li></ul><p><strong>几种常见MQ的对比：</strong></p><p>目前业界有很多的 MQ产品，例如 RabbitMQ、RocketMQ、ActiveMQ、Kafka、ZeroMQ、MetaMq等，也有直接使用 Redis充当消息队列的案例，而这些消息队列产品，各有侧重，在实际选型时，需要结合自身需求及 MQ 产品特征，综合考虑。下面是常见MQ产品的对比</p><p><img src="'+m+'" alt="1570776103472"></p><blockquote><p>追求可用性：Kafka、 RocketMQ 、RabbitMQ</p><p>追求可靠性：RabbitMQ、RocketMQ</p><p>追求吞吐能力：RocketMQ、Kafka</p><p>追求消息低延迟：RabbitMQ、Kafka</p></blockquote><h1 id="_2-快速入门" tabindex="-1">2.快速入门 <a class="header-anchor" href="#_2-快速入门" aria-hidden="true">#</a></h1><h2 id="_2-1-rabbitmq概述" tabindex="-1">2.1 RabbitMQ概述 <a class="header-anchor" href="#_2-1-rabbitmq概述" aria-hidden="true">#</a></h2><h3 id="_2-1-1-安装rabbitmq" tabindex="-1">2.1.1 安装RabbitMQ <a class="header-anchor" href="#_2-1-1-安装rabbitmq" aria-hidden="true">#</a></h3><p>安装RabbitMQ，参考课前资料：</p><p><img src="'+E+`" alt="image-20210717162628635"></p><h5 id="a-下载镜像" tabindex="-1">a. 下载镜像 <a class="header-anchor" href="#a-下载镜像" aria-hidden="true">#</a></h5><p>方式一：在线拉取</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pull</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rabbitmq:</span><span style="color:#F78C6C;">3.8</span><span style="color:#C3E88D;">-management</span></span>
<span class="line"></span></code></pre></div><p>方式二：从本地加载</p><p>在课前资料已经提供了镜像包：</p><p><img src="`+b+`" alt="image-20210423191210349"></p><p>上传到虚拟机中后，使用命令加载镜像即可：</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">load</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mq.tar</span></span>
<span class="line"></span></code></pre></div><h5 id="b-安装mq" tabindex="-1">b. 安装MQ <a class="header-anchor" href="#b-安装mq" aria-hidden="true">#</a></h5><p>执行下面的命令来运行MQ容器：</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-e</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">RABBITMQ_DEFAULT_USER=itcast</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-e</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">RABBITMQ_DEFAULT_PASS=</span><span style="color:#F78C6C;">123321</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-v</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mq-plugins:/plugins</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--name</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mq</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--hostname</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mq</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">15672</span><span style="color:#C3E88D;">:</span><span style="color:#F78C6C;">15672</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5672</span><span style="color:#C3E88D;">:</span><span style="color:#F78C6C;">5672</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rabbitmq:</span><span style="color:#F78C6C;">3.8</span><span style="color:#C3E88D;">-management</span></span>
<span class="line"></span></code></pre></div><p><img src="`+q+'" alt="image-20220214104305480"></p><h3 id="_2-1-2-rabbitmq的图形管理界面" tabindex="-1">2.1.2 <strong>RabbitMQ的图形管理界面</strong> <a class="header-anchor" href="#_2-1-2-rabbitmq的图形管理界面" aria-hidden="true">#</a></h3><p>为了更加方便的管理RabbitMQ服务，RabbitMQ提供了一个浏览器端管理界面，可以通过浏览器页面方便的进行服务管理。</p><blockquote><p>打开浏览器访问网站http://192.168.xx.xx:15672进入登录页面: 输入 itcast - --- 123321</p></blockquote><p><img src="'+f+'" alt="image-20220214093639892"></p><blockquote><p>可以在管理界面中进行 交换机、队列、用户管理等操作.</p></blockquote><h3 id="_2-1-3-rabbitmq的基本结构" tabindex="-1">2.1.3 <strong>RabbitMQ的基本结构：</strong> <a class="header-anchor" href="#_2-1-3-rabbitmq的基本结构" aria-hidden="true">#</a></h3><p><img src="'+_+'" alt="image-20210717162752376"></p><p><strong>RabbitMQ中的一些角色：</strong></p><ul><li>publisher：生产者</li><li>consumer：消费者</li><li>exchange个：交换机，负责消息路由</li><li>queue：队列，存储消息</li><li>virtualHost：虚拟主机，隔离不同租户的exchange、queue、消息的隔离</li></ul><p><img src="'+v+'" alt="image-20220214183005771"></p><h2 id="_2-2-rabbitmq消息模型" tabindex="-1">2.2.RabbitMQ消息模型 <a class="header-anchor" href="#_2-2-rabbitmq消息模型" aria-hidden="true">#</a></h2><p>RabbitMQ官方<code>https://www.rabbitmq.com/getstarted.html</code>提供了5个不同的Demo示例，对应了不同的消息模型：</p><p><img src="'+k+'" alt="image-20210717163332646"></p><h4 id="小结-1" tabindex="-1">小结： <a class="header-anchor" href="#小结-1" aria-hidden="true">#</a></h4><blockquote><p><strong>RabbitMQ提供了6种模式：</strong></p><ul><li>1.简单模式</li><li>2.work模式</li><li>Publish/Subscribe发布与订阅模式 <ul><li>3.fanout 广播模式</li><li>4.Routing 路由模式 （定向模式）</li><li>5.Topics 主题模式 （通配符模式）</li></ul></li><li>RPC远程调用模式（远程调用，不太算MQ；暂不作介绍）；</li></ul></blockquote><h2 id="_2-3-导入demo工程" tabindex="-1">2.3.导入Demo工程 <a class="header-anchor" href="#_2-3-导入demo工程" aria-hidden="true">#</a></h2><p>课前资料提供了一个Demo工程，mq-demo:</p><p><img src="'+x+'" alt="image-20210717163253264"></p><p>导入后可以看到结构如下：</p><p><img src="'+B+'" alt="image-20210717163604330"></p><p>包括三部分：</p><ul><li>mq-demo：父工程，管理项目依赖</li><li>publisher：消息的发送者</li><li>consumer：消息的消费者</li></ul><h2 id="_2-4-入门案例" tabindex="-1">2.4.入门案例 <a class="header-anchor" href="#_2-4-入门案例" aria-hidden="true">#</a></h2><p>简单队列模式的模型图：</p><p><img src="'+Q+`" alt="image-20210717163434647"></p><p>官方的HelloWorld是基于最基础的消息队列模型来实现的，只包括三个角色：</p><ul><li>publisher：消息发布者，将消息发送到队列queue</li><li>queue：消息队列，负责接受并缓存消息</li><li>consumer：订阅队列，处理队列中的消息</li></ul><h3 id="_2-4-1-publisher实现" tabindex="-1">2.4.1.publisher实现 <a class="header-anchor" href="#_2-4-1-publisher实现" aria-hidden="true">#</a></h3><p>思路：</p><ul><li>建立连接</li><li>创建Channel</li><li>声明队列</li><li>发送消息</li><li>关闭连接和channel</li></ul><p>代码实现：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">cn</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">itcast</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">helloworld</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">rabbitmq</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">client</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Channel</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">rabbitmq</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">client</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Connection</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">rabbitmq</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">client</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">ConnectionFactory</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">junit</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Test</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">io</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">IOException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">util</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">concurrent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">TimeoutException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">PublisherTest</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSendMessage</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">IOException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeoutException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 1.建立连接</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">ConnectionFactory</span><span style="color:#A6ACCD;"> factory </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ConnectionFactory</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span></span>
<span class="line"><span style="color:#A6ACCD;">        factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setHost</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">192.168.150.101</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setPort</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">5672</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setVirtualHost</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setUsername</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">itcast</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setPassword</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">123321</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 1.2.建立连接</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Connection</span><span style="color:#A6ACCD;"> connection </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newConnection</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 2.创建通道Channel</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Channel</span><span style="color:#A6ACCD;"> channel </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> connection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createChannel</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 3.创建队列</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> queueName </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">simple.queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        channel</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">queueDeclare</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queueName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 4.发送消息</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hello, rabbitmq!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        channel</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">basicPublish</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> queueName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#A6ACCD;"> message</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBytes</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">发送消息成功：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 5.关闭通道和连接</span></span>
<span class="line"><span style="color:#A6ACCD;">        channel</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        connection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_2-4-2-consumer实现" tabindex="-1">2.4.2.consumer实现 <a class="header-anchor" href="#_2-4-2-consumer实现" aria-hidden="true">#</a></h3><p>代码思路：</p><ul><li>建立连接</li><li>创建Channel</li><li>声明队列</li><li>订阅消息</li></ul><p>代码实现：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">cn</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">itcast</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">helloworld</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">rabbitmq</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">client</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">*</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">io</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">IOException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">util</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">concurrent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">TimeoutException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ConsumerTest</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">IOException</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeoutException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 1.建立连接</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">ConnectionFactory</span><span style="color:#A6ACCD;"> factory </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ConnectionFactory</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span></span>
<span class="line"><span style="color:#A6ACCD;">        factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setHost</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">192.168.150.101</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setPort</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">5672</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setVirtualHost</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setUsername</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">itcast</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setPassword</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">123321</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 1.2.建立连接</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Connection</span><span style="color:#A6ACCD;"> connection </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> factory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">newConnection</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 2.创建通道Channel</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">Channel</span><span style="color:#A6ACCD;"> channel </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> connection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createChannel</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 3.创建队列</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> queueName </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">simple.queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        channel</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">queueDeclare</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queueName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 4.订阅消息</span></span>
<span class="line"><span style="color:#A6ACCD;">        channel</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">basicConsume</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queueName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DefaultConsumer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">channel</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handleDelivery</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">consumerTag</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Envelope</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">envelope</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                       </span><span style="color:#C792EA;">AMQP</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">BasicProperties</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">properties</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">byte</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">body</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">throws</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">IOException</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;font-style:italic;">// 5.处理消息</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">String</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">body</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">接收到消息：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">等待接收消息。。。。</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="_2-5-总结" tabindex="-1">2.5.总结 <a class="header-anchor" href="#_2-5-总结" aria-hidden="true">#</a></h2><p>基本消息队列的消息发送流程：</p><ol><li><p>建立connection</p></li><li><p>创建channel</p></li><li><p>利用channel声明队列</p></li><li><p>利用channel向队列发送消息</p></li></ol><p>基本消息队列的消息接收流程：</p><ol><li><p>建立connection</p></li><li><p>创建channel</p></li><li><p>利用channel声明队列</p></li><li><p>定义consumer的消费行为handleDelivery()</p></li><li><p>利用channel将消费者与队列绑定</p></li></ol><h1 id="_3-springamqp" tabindex="-1">3.SpringAMQP <a class="header-anchor" href="#_3-springamqp" aria-hidden="true">#</a></h1><p>SpringAMQP是基于RabbitMQ封装的一套模板，并且还利用SpringBoot对其实现了自动装配，使用起来非常方便。</p><p>SpringAmqp的官方地址：<a href="https://spring.io/projects/spring-amqp" target="_blank" rel="noreferrer">https://spring.io/projects/spring-amqp</a></p>`,130),J=n(`<p>SpringAMQP提供了三个功能：</p><ul><li>自动声明队列、交换机及其绑定关系</li><li>基于注解的监听器模式，异步接收消息</li><li>封装了RabbitTemplate工具，用于发送消息</li></ul><h2 id="_3-1-basic-queue-简单队列模型" tabindex="-1">3.1.Basic Queue 简单队列模型 <a class="header-anchor" href="#_3-1-basic-queue-简单队列模型" aria-hidden="true">#</a></h2><p>在父工程mq-demo中引入依赖</p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">&lt;!--AMQP依赖，包含RabbitMQ--&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">org.springframework.boot</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">spring-boot-starter-amqp</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-1-1-消息发送" tabindex="-1">3.1.1.消息发送 <a class="header-anchor" href="#_3-1-1-消息发送" aria-hidden="true">#</a></h3><p>首先配置MQ地址，在publisher服务的application.yml中添加配置：</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">spring</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rabbitmq</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">192.168.150.101</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 主机名</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5672</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 端口</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">virtual-host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 虚拟主机</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">itcast</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 用户名</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">123321</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 密码</span></span>
<span class="line"></span></code></pre></div><p>然后在publisher服务中编写测试类SpringAmqpTest，并利用RabbitTemplate实现消息发送：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">cn</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">itcast</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">spring</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">junit</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Test</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">junit</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">runner</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">RunWith</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">amqp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">rabbit</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">core</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">RabbitTemplate</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">beans</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">factory</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">annotation</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Autowired</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">boot</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">test</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">context</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">SpringBootTest</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">test</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">context</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">junit4</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">SpringRunner</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RunWith</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SpringRunner</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">SpringBootTest</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SpringAmqpTest</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Autowired</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">RabbitTemplate</span><span style="color:#A6ACCD;"> rabbitTemplate</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSimpleQueue</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 队列名称</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> queueName </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">simple.queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 消息</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hello, spring amqp!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 发送消息</span></span>
<span class="line"><span style="color:#A6ACCD;">        rabbitTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">convertAndSend</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queueName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> message</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-1-2-消息接收" tabindex="-1">3.1.2.消息接收 <a class="header-anchor" href="#_3-1-2-消息接收" aria-hidden="true">#</a></h3><p>首先配置MQ地址，在consumer服务的application.yml中添加配置：</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">spring</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rabbitmq</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">192.168.150.101</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 主机名</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5672</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 端口</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">virtual-host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 虚拟主机</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">username</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">itcast</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 用户名</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">123321</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 密码</span></span>
<span class="line"></span></code></pre></div><p>然后在consumer服务的<code>cn.itcast.mq.listener</code>包中新建一个类SpringRabbitListener，代码如下：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">cn</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">itcast</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">listener</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">amqp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">rabbit</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">annotation</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">stereotype</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Component</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Component</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SpringRabbitListener</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">queues</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">simple.queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">listenSimpleQueueMessage</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">msg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">spring 消费者接收到消息：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-1-3-测试" tabindex="-1">3.1.3.测试 <a class="header-anchor" href="#_3-1-3-测试" aria-hidden="true">#</a></h3><p>启动consumer服务，然后在publisher服务中运行测试代码，发送MQ消息</p><h3 id="小结-2" tabindex="-1">小结： <a class="header-anchor" href="#小结-2" aria-hidden="true">#</a></h3><p><strong>简单模式：</strong></p><blockquote><p>实现功能： 一个生产者 P 发送消息到队列 Q，一个消费者 C 接收 （一个生产者对应一个消费者）</p><p><img src="`+S+'" alt="img"></p><p>在上图的模型中，有以下概念：</p><p>P：生产者 也就是要发送消息的程序</p><p>C：消费者： 消息的接受者，会一直等待消息到来。</p><p>queue：消息队列，图中红色部分。类似一个邮箱，可以缓存消息；生产者向其中投递消息，消费者从其中取出消息。</p></blockquote><p><img src="'+M+'" alt="img"></p><h2 id="_3-2-workqueue-工作队列模式" tabindex="-1">3.2.WorkQueue 工作队列模式 <a class="header-anchor" href="#_3-2-workqueue-工作队列模式" aria-hidden="true">#</a></h2><p>Work queues，也被称为（Task queues），任务模型。简单来说就是<strong>让多个消费者绑定到一个队列，共同消费队列中的消息</strong>。</p><blockquote><p>一个生产者对应多个消费者,但是只能有一个消费者获得消息</p></blockquote><p><img src="'+j+`" alt="image-20210717164238910"></p><p>当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。</p><p>此时就可以使用work 模型，多个消费者共同处理消息处理，速度就能大大提高了。</p><blockquote><p><em><strong>*对比：*</strong></em></p><p>Work Queues与入门程序的<code>简单模式</code>相比，多了一个或一些消费端，多个消费端共同消费同一个队列中的消息。</p><p>（简单队列是一一对应的关系，即点对点，一个生产者对应一个消费者，按照这个逻辑，如果我们有一些比较耗时的任务，也就意味着需要大量的时间才能处理完毕，显然简单队列模式并不能满足我们的工作需求，因此就需要用到我们的工作队列）</p><p><em><strong>*应用场景：*</strong></em></p><p>对于 任务过重或任务较多情况使用工作队列可以提高任务处理的速度。</p></blockquote><h3 id="_3-2-1-消息发送" tabindex="-1">3.2.1.消息发送 <a class="header-anchor" href="#_3-2-1-消息发送" aria-hidden="true">#</a></h3><p>这次我们循环发送，模拟大量消息堆积现象。</p><p>在publisher服务中的SpringAmqpTest类中添加一个测试方法：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * workQueue</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 向队列中不停发送消息，模拟消息堆积。</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testWorkQueue</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 队列名称</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> queueName </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">simple.queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 消息</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hello, message_</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">50</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 发送消息</span></span>
<span class="line"><span style="color:#A6ACCD;">        rabbitTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">convertAndSend</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">queueName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">20</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-2-2-消息接收" tabindex="-1">3.2.2.消息接收 <a class="header-anchor" href="#_3-2-2-消息接收" aria-hidden="true">#</a></h3><p>要模拟多个消费者绑定同一个队列，我们在consumer服务的SpringRabbitListener中添加2个新的方法：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">queues</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">simple.queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">listenWorkQueue1</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">消费者1接收到消息：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> LocalTime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">20</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">queues</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">simple.queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">listenWorkQueue2</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">消费者2........接收到消息：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> LocalTime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#A6ACCD;">    Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">200</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>注意到这个消费者sleep了1000秒，模拟任务耗时。</p><h3 id="_3-2-3-测试" tabindex="-1">3.2.3.测试 <a class="header-anchor" href="#_3-2-3-测试" aria-hidden="true">#</a></h3><p>启动ConsumerApplication后，在执行publisher服务中刚刚编写的发送测试方法testWorkQueue。</p><p>可以看到消费者1很快完成了自己的25条消息。消费者2却在缓慢的处理自己的25条消息。</p><p>也就是说消息是平均分配给每个消费者，并没有考虑到消费者的处理能力。这样显然是有问题的。</p><h3 id="_3-2-4-能者多劳" tabindex="-1">3.2.4.能者多劳 <a class="header-anchor" href="#_3-2-4-能者多劳" aria-hidden="true">#</a></h3><p>在spring中有一个简单的配置，可以解决这个问题。我们修改consumer服务的application.yml文件，添加配置：</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">spring</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">rabbitmq</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">listener</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">simple</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">prefetch</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 每次只能获取一条消息，处理完成才能获取下一个消息</span></span>
<span class="line"></span></code></pre></div><h3 id="小结-3" tabindex="-1">小结： <a class="header-anchor" href="#小结-3" aria-hidden="true">#</a></h3><p><strong>工作队列模式：</strong></p><ul><li>多个消费者绑定到一个队列，同一条消息只会被一个消费者处理</li><li>通过设置prefetch来控制消费者预取的消息数量</li></ul><p>**应用场景：**可以在消费者端处理任务比较耗时的时候；添加对同一个队列的消费者来提高任务处理能力。</p><p><img src="`+T+'" alt="img"></p><p><img src="'+R+'" alt="img"></p><h5 id="特点" tabindex="-1"><strong>特点：</strong> <a class="header-anchor" href="#特点" aria-hidden="true">#</a></h5><blockquote><p>在一个队列中如果有多个消费者，那么消费者之间对于同一个消息的关系是竞争的关系。</p><p>主要解决问题：处理资源密集型任务，并且还要等他完成。有了工作队列，我们就可以将具体的工作放到后面去做，将工作封装为一个消息，发送到队列中，一个工作进程就可以取出消息并完成工作。如果启动了多个工作进程，那么工作就可以在多个进程间共享。</p></blockquote><h5 id="补充" tabindex="-1">补充： <a class="header-anchor" href="#补充" aria-hidden="true">#</a></h5><blockquote><p>工作队列也称为公平性队列模式，多个消费者会对消息进行循环分发！</p><p>假如我们拥有两个消费者，默认情况下，RabbitMQ 将按顺序将每条消息发送给下一个消费者，平均而言，每个消费者将获得相同数量的消息，这种分发消息的方式称为轮询。</p></blockquote><h5 id="注意" tabindex="-1">注意： <a class="header-anchor" href="#注意" aria-hidden="true">#</a></h5><blockquote><p>简单模式 和 工作队列模式 都是点到点的， 一条消息，只能被一个消费者消费！</p><p>但是订阅模式，可以实现，一条消息，被多个消费者消费！</p></blockquote><h2 id="_3-3-发布-订阅" tabindex="-1">3.3.发布/订阅 <a class="header-anchor" href="#_3-3-发布-订阅" aria-hidden="true">#</a></h2><p>发布订阅的模型如图：</p><p><img src="'+w+'" alt="image-20210717165309625"></p><p>可以看到，<strong>在订阅模型中，多了一个exchange角色</strong>，而且过程略有变化：</p><ul><li>Publisher：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</li><li>Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有以下3种类型： <ul><li>Fanout：广播，将消息交给所有绑定到交换机的队列</li><li>Direct：定向，把消息交给符合指定routing key 的队列</li><li>Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列</li></ul></li><li>Consumer：消费者，与以前一样，订阅队列，没有变化</li><li>Queue：消息队列也与以前一样，接收消息、缓存消息。</li></ul><h4 id="小结-4" tabindex="-1">小结： <a class="header-anchor" href="#小结-4" aria-hidden="true">#</a></h4><blockquote><ul><li>在订阅模型中，多了一个exchange角色</li><li><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！</li><li>交换机的三种类型.</li></ul></blockquote><h2 id="_3-4-fanout-广播" tabindex="-1">3.4.Fanout 广播 <a class="header-anchor" href="#_3-4-fanout-广播" aria-hidden="true">#</a></h2><p><img src="'+P+'" alt="image-20210717165438225"></p><p>在广播模式下，消息发送流程是这样的：</p><ul><li>1） 可以有多个队列</li><li>2） 每个队列都要绑定到Exchange（交换机）</li><li>3） 生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定</li><li>4） 交换机把消息发送给绑定过的所有队列</li><li>5） 订阅队列的消费者都能拿到消息</li></ul><p>我们的计划是这样的：</p><ul><li>创建一个交换机 itcast.fanout，类型是Fanout</li><li>创建两个队列fanout.queue1和fanout.queue2，绑定到交换机itcast.fanout</li></ul><p><img src="'+N+'" alt="image-20210717165509466"></p><h3 id="_3-4-1-声明队列和交换机" tabindex="-1">3.4.1.声明队列和交换机 <a class="header-anchor" href="#_3-4-1-声明队列和交换机" aria-hidden="true">#</a></h3><p>Spring提供了一个接口Exchange，来表示所有不同类型的交换机：</p><p><img src="'+O+`" alt="image-20210717165552676"></p><p>在consumer中创建一个类，声明队列和交换机：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">package</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">cn</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">itcast</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">mq</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">config</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">amqp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">core</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Binding</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">amqp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">core</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">BindingBuilder</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">amqp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">core</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">FanoutExchange</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">amqp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">core</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Queue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">context</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">annotation</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Bean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">context</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">annotation</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Configuration</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Configuration</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">FanoutConfig</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 声明交换机</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * </span><span style="color:#F78C6C;font-style:italic;">@return</span><span style="color:#676E95;font-style:italic;"> Fanout类型交换机</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FanoutExchange</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fanoutExchange</span><span style="color:#89DDFF;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">FanoutExchange</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">itcast.fanout</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 第1个队列</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Queue</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fanoutQueue1</span><span style="color:#89DDFF;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Queue</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanout.queue1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 绑定队列和交换机</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Binding</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">bindingQueue1</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Queue</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">fanoutQueue1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FanoutExchange</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">fanoutExchange</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> BindingBuilder</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fanoutQueue1</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fanoutExchange</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 第2个队列</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Queue</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fanoutQueue2</span><span style="color:#89DDFF;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Queue</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanout.queue2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 绑定队列和交换机</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Binding</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">bindingQueue2</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Queue</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">fanoutQueue2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FanoutExchange</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">fanoutExchange</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> BindingBuilder</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fanoutQueue2</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fanoutExchange</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-4-2-消息发送" tabindex="-1">3.4.2.消息发送 <a class="header-anchor" href="#_3-4-2-消息发送" aria-hidden="true">#</a></h3><p>在publisher服务的SpringAmqpTest类中添加测试方法：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testFanoutExchange</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 队列名称</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> exchangeName </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">itcast.fanout</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 消息</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hello, everyone!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    rabbitTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">convertAndSend</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">exchangeName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> message</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-4-3-消息接收" tabindex="-1">3.4.3.消息接收 <a class="header-anchor" href="#_3-4-3-消息接收" aria-hidden="true">#</a></h3><p>在consumer服务的SpringRabbitListener中添加两个方法，作为消费者：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">queues</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanout.queue1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">listenFanoutQueue1</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">消费者1接收到Fanout消息：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">queues</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">fanout.queue2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">listenFanoutQueue2</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">消费者2接收到Fanout消息：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="小结-5" tabindex="-1">小结： <a class="header-anchor" href="#小结-5" aria-hidden="true">#</a></h3><blockquote><p><strong>交换机的作用是什么？</strong></p><ul><li>路由publisher发送的消息</li><li>将消息按照规则路由到与之绑定的队列</li><li>不能缓存消息，路由失败，消息丢失</li><li>FanoutExchange的会将消息路由到每个绑定的队列</li></ul><p><strong>声明队列、交换机、绑定关系的Bean是什么？</strong></p><ul><li>Queue</li><li>FanoutExchange</li><li>Binding</li></ul></blockquote><p><img src="`+I+'" alt="image-20220214100303630"></p><h2 id="_3-5-direct-定向" tabindex="-1">3.5.Direct 定向 <a class="header-anchor" href="#_3-5-direct-定向" aria-hidden="true">#</a></h2><p>在Fanout模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到Direct类型的Exchange。</p><p><img src="'+L+'" alt="image-20210717170041447"></p><p>在Direct模型下：</p><ul><li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个<code>RoutingKey</code>（路由key）</li><li>消息的发送方在 向 Exchange发送消息时，也必须指定消息的 <code>RoutingKey</code>。</li><li>Exchange不再把消息交给每一个绑定的队列，而是根据消息的<code>Routing Key</code>进行判断，只有队列的<code>Routingkey</code>与消息的 <code>Routing key</code>完全一致，才会接收到消息</li></ul><p><strong>案例需求如下</strong>：</p><ol><li><p>利用@RabbitListener声明Exchange、Queue、RoutingKey</p></li><li><p>在consumer服务中，编写两个消费者方法，分别监听direct.queue1和direct.queue2</p></li><li><p>在publisher中编写测试方法，向itcast. direct发送消息</p></li></ol><p><img src="'+X+`" alt="image-20210717170223317"></p><h3 id="_3-5-1-基于注解声明队列和交换机" tabindex="-1">3.5.1.基于注解声明队列和交换机 <a class="header-anchor" href="#_3-5-1-基于注解声明队列和交换机" aria-hidden="true">#</a></h3><p>基于@Bean的方式声明队列和交换机比较麻烦，Spring还提供了基于注解方式来声明。</p><p>在consumer的SpringRabbitListener中添加两个消费者，同时基于注解来声明队列和交换机：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">bindings</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">QueueBinding</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Queue</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">direct.queue1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">exchange</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Exchange</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">itcast.direct</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ExchangeTypes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DIRECT</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">key</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">red</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">blue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">listenDirectQueue1</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">消费者接收到direct.queue1的消息：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">bindings</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">QueueBinding</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Queue</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">direct.queue2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">exchange</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Exchange</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">itcast.direct</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ExchangeTypes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DIRECT</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">key</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">red</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">yellow</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">listenDirectQueue2</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">消费者接收到direct.queue2的消息：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-5-2-消息发送" tabindex="-1">3.5.2.消息发送 <a class="header-anchor" href="#_3-5-2-消息发送" aria-hidden="true">#</a></h3><p>在publisher服务的SpringAmqpTest类中添加测试方法：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSendDirectExchange</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 交换机名称</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> exchangeName </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">itcast.direct</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 消息</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">红色警报！日本乱排核废水，导致海洋生物变异，惊现哥斯拉！</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 发送消息</span></span>
<span class="line"><span style="color:#A6ACCD;">    rabbitTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">convertAndSend</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">exchangeName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">red</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> message</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="小结-6" tabindex="-1">小结： <a class="header-anchor" href="#小结-6" aria-hidden="true">#</a></h3><blockquote><p><strong>Direct交换机与Fanout交换机的差异？</strong></p><ul><li>Fanout交换机将消息路由给每一个与之绑定的队列</li><li>Direct交换机根据RoutingKey判断路由给哪个队列</li><li>如果多个队列具有相同的RoutingKey，则与Fanout功能类似</li></ul><p>基于@RabbitListener注解声明队列和交换机有哪些常见注解？</p><ul><li>@Queue</li><li>@Exchange</li></ul></blockquote><h2 id="_3-6-topic-通配符" tabindex="-1">3.6 Topic 通配符 <a class="header-anchor" href="#_3-6-topic-通配符" aria-hidden="true">#</a></h2><h3 id="_3-6-1-说明" tabindex="-1">3.6.1.说明 <a class="header-anchor" href="#_3-6-1-说明" aria-hidden="true">#</a></h3><p><code>Topic</code>类型的<code>Exchange</code>与<code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过<code>Topic</code>类型<code>Exchange</code>可以让队列在绑定<code>Routing key</code> 的时候使用通配符！</p><p><code>Routingkey</code> 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： <code>item.insert</code></p><p>通配符规则：</p><p><code>#</code>：匹配一个或多个词</p><p><code>*</code>：匹配不多不少恰好1个词</p><p>举例：</p><p><code>item.#</code>：能够匹配<code>item.spu.insert</code> 或者 <code>item.spu</code></p><p><code>item.*</code>：只能匹配<code>item.spu</code></p><p>​</p><p>图示：</p><p><img src="`+V+'" alt="image-20210717170705380"></p><p>解释：</p><ul><li>Queue1：绑定的是<code>china.#</code> ，因此凡是以 <code>china.</code>开头的<code>routing key</code> 都会被匹配到。包括china.news和china.weather</li><li>Queue2：绑定的是<code>#.news</code> ，因此凡是以 <code>.news</code>结尾的 <code>routing key</code> 都会被匹配。包括china.news和japan.news</li></ul><p>案例需求：</p><p>实现思路如下：</p><ol><li><p>并利用@RabbitListener声明Exchange、Queue、RoutingKey</p></li><li><p>在consumer服务中，编写两个消费者方法，分别监听topic.queue1和topic.queue2</p></li><li><p>在publisher中编写测试方法，向itcast. topic发送消息</p></li></ol><p><img src="'+z+`" alt="image-20210717170829229"></p><h3 id="_3-6-2-消息发送" tabindex="-1">3.6.2.消息发送 <a class="header-anchor" href="#_3-6-2-消息发送" aria-hidden="true">#</a></h3><p>在publisher服务的SpringAmqpTest类中添加测试方法：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * topicExchange</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSendTopicExchange</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 交换机名称</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> exchangeName </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">itcast.topic</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 消息</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">喜报！孙悟空大战哥斯拉，胜!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 发送消息</span></span>
<span class="line"><span style="color:#A6ACCD;">    rabbitTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">convertAndSend</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">exchangeName</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">china.news</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> message</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-6-3-消息接收" tabindex="-1">3.6.3.消息接收 <a class="header-anchor" href="#_3-6-3-消息接收" aria-hidden="true">#</a></h3><p>在consumer服务的SpringRabbitListener中添加方法：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">bindings</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">QueueBinding</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Queue</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topic.queue1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">exchange</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Exchange</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">itcast.topic</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ExchangeTypes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">TOPIC</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">key</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">china.#</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">listenTopicQueue1</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">消费者接收到topic.queue1的消息：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">bindings</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">QueueBinding</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Queue</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">topic.queue2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">exchange</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Exchange</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">itcast.topic</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ExchangeTypes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">TOPIC</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">key</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">#.news</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">listenTopicQueue2</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">    System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">消费者接收到topic.queue2的消息：【</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">】</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="小结-7" tabindex="-1">小结： <a class="header-anchor" href="#小结-7" aria-hidden="true">#</a></h3><blockquote><p><strong>描述下Direct交换机与Topic交换机的差异？</strong></p><ul><li><p>**相同点：**都是可以根据 RoutingKey 把消息路由到不同的队列。</p></li><li><p><strong>不同点：</strong> Topic在配置routing key 的时候可以使用通配符，显得更加灵活。</p></li><li><p>Topic交换机接收的消息RoutingKey必须是多个单词，以 <code>.</code> 分割</p></li><li><p>Topic 类型与 Direct 相比，都是可以根据 RoutingKey 把消息路由到不同的队列。只不过 Topic 类型 Exchange 可以让队列在绑定 Routing key 的时候使用通配符！</p><ul><li><code>#</code>：代表0个或多个词</li><li><code>*</code>：代表1个词</li></ul></li></ul><p><strong>举例：</strong></p><p>item.# ：能够匹配 item.aa.bb或者 item.aa</p><p>item.* ：只能匹配 item.aa</p></blockquote><p>![img](file:///C:\\Users\\chuck\\AppData\\Local\\Temp\\ksohtml\\wps4EBA.tmp.jpg)</p><h2 id="_3-7-消息转换器" tabindex="-1">3.7.消息转换器 <a class="header-anchor" href="#_3-7-消息转换器" aria-hidden="true">#</a></h2><p>之前说过，Spring会把你发送的消息序列化为字节发送给MQ，接收消息的时候，还会把字节反序列化为Java对象。</p><p><img src="`+K+`" alt="image-20200525170410401"></p><p>只不过，默认情况下Spring采用的序列化方式是JDK序列化。众所周知，JDK序列化存在下列问题：</p><ul><li>数据体积过大</li><li>有安全漏洞</li><li>可读性差</li></ul><p>我们来测试一下。</p><h3 id="_3-7-1-测试默认转换器" tabindex="-1">3.7.1.测试默认转换器 <a class="header-anchor" href="#_3-7-1-测试默认转换器" aria-hidden="true">#</a></h3><p>我们修改消息发送的代码，发送一个Map对象：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSendMap</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 准备消息</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Map</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">HashMap</span><span style="color:#89DDFF;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">    msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Jack</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">age</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">21</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 发送消息</span></span>
<span class="line"><span style="color:#A6ACCD;">    rabbitTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">convertAndSend</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">simple.queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>停止consumer服务</p><p>发送消息后查看控制台：</p><p><img src="`+W+`" alt="image-20210422232835363"></p><h3 id="_3-7-2-配置json转换器" tabindex="-1">3.7.2.配置JSON转换器 <a class="header-anchor" href="#_3-7-2-配置json转换器" aria-hidden="true">#</a></h3><p>显然，JDK序列化方式并不合适。我们希望消息体的体积更小、可读性更高，因此可以使用JSON方式来做序列化和反序列化。</p><p>在publisher和consumer两个服务中都引入依赖：</p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">com.fasterxml.jackson.dataformat</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">groupId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">jackson-dataformat-xml</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">artifactId</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">2.9.10</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">version</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">dependency</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>配置消息转换器。</p><p>在启动类中添加一个Bean即可：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">MessageConverter</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">jsonMessageConverter</span><span style="color:#89DDFF;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Jackson2JsonMessageConverter</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-7-3-消息发送" tabindex="-1">3.7.3.消息发送 <a class="header-anchor" href="#_3-7-3-消息发送" aria-hidden="true">#</a></h3><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Test</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testSendMap</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> throws InterruptedException </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 准备消息</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">Map</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">Object</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> msg </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">HashMap</span><span style="color:#89DDFF;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">    msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Jack</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    msg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">put</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">age</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">21</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 发送消息</span></span>
<span class="line"><span style="color:#A6ACCD;">    rabbitTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">convertAndSend</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">simple.queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-7-4-消息接收" tabindex="-1">3.7.4.消息接收 <a class="header-anchor" href="#_3-7-4-消息接收" aria-hidden="true">#</a></h3><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">RabbitListener</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">queues</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">object.queue</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">listenObjectQueue</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Map</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">String</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#A6ACCD;">        System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">println</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">接收到object.queue的消息：</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><img src="`+U+'" alt="image-20220214181435397"></p><blockquote><p>解决JDK序列化的下列问题：</p><ul><li>数据体积过大</li><li>有安全漏洞</li><li>可读性差</li></ul></blockquote><h1 id="模式总结" tabindex="-1"><strong>模式总结</strong> <a class="header-anchor" href="#模式总结" aria-hidden="true">#</a></h1><p><strong>五种模式，可以分为两大类：</strong></p><blockquote><p><strong>不直接Exchange交换机（默认交换机）：</strong></p><ol><li><p>simple简单模式：一个生产者生产一个消息到一个队列被一个消费者接收</p></li><li><p>work工作队列模式：生产者发送消息到一个队列中，然后可以被多个消费者监听该队列；一个消息只能被一个消费者接收，消费者之间是竞争关系</p></li></ol><p><strong>使用Exchange交换机；订阅模式（交换机：广播fanout、定向direct、通配符topic）</strong></p><ol><li><p>广播模式：使用了fanout广播类型的交换机，可以将一个消息发送到所有绑定了该交换机的队列</p></li><li><p>路由模式：使用了direct定向类型的交换机，消费会携带路由key，交换机根据消息的路由key与队列的路由key进行对比，一致的话那么该队列可以接收到消息</p></li><li><p>通配符模式：使用了topic通配符类型的交换机，消费会携带路由key（*， #），交换机根据消息的路由key与队列的路由key进行对比，匹配的话那么该队列可以接收到消息</p></li></ol></blockquote>',156);function Z(G,$,ss,as,ns,ls){const s=l;return e(),o("div",null,[Y,a(s,{src:"assets/image-20210717164024967.png",alt:"image-20210717164024967",style:{zoom:"67%"}}),a(s,{src:"assets/image-20210717164038678.png",alt:"image-20210717164038678",style:{zoom:"67%"}}),J])}const ts=p(H,[["render",Z]]);export{es as __pageData,ts as default};
